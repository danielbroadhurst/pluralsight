create database ExecuteAs
use ExecuteAs


create table wormholes
(
id int,
size varchar(100)
)

create user workerbee from login [darkmatter5\workerbee]


execute as user = 'workerbee'

insert into wormholes values (1, 'big')

revert


create proc ShootMeAnAstroid (@key int, @size varchar(50))
as
insert into wormholes values (@key, @size)



grant execute on ShootMeAnAstroid to workerbee



execute as user = 'workerbee'

exec ShootMeAnAstroid 1, 'big'

select user

revert

select * from wormholes



create proc JustShootMe (@cmd nvarchar(max))
as
exec sp_executesql @cmd

grant execute on JustShootMe to workerbee


execute as user = 'workerbee'

exec JustShootMe 'insert into wormholes values (2, ''bigger'')'

revert



create proc JustShootMe2 (@cmd nvarchar(max))
with execute as self
as
exec sp_executesql @cmd



grant execute on JustShootMe2 to workerbee


execute as user = 'workerbee'

exec JustShootMe2 'insert into wormholes values (2, ''bigger'')'

revert


select * from wormholes






























































































































































































































































































































































































